apiVersion: v1
kind: ConfigMap
metadata:
  name: pulumi-cmp-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: pulumi-python
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args: ["pulumi-init"]
      generate:
        command: ["/bin/sh", "-c"]
        args: ["pulumi-generate"]
      discover:
        fileName: "Pulumi.yaml"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomized-helm-cmp-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: kustomized-helm
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args: ["helm dependency build"]
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            # Argo CD passes "namespace_name" as ARGOCD_APP_NAME. We need to extract the name.
            RELEASE_NAME=$(echo $ARGOCD_APP_NAME | awk -F_ '{print $NF}')
            
            helm template . --name-template $RELEASE_NAME --namespace $ARGOCD_APP_NAMESPACE --include-crds > all.yaml && kustomize build
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomized-git-helm-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: kustomized-git-helm
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Starting Init..." >&2
            
            # Parse git-chart.yaml for repo, ref, and chart_path
            REPO=$(grep 'repo:' git-chart.yaml | awk '{print $2}')
            REF=$(grep 'ref:' git-chart.yaml | awk '{print $2}')
            CHART_PATH=$(grep 'path:' git-chart.yaml | awk '{print $2}')
            
            echo "Repo: $REPO, Ref: $REF, Path: $CHART_PATH" >&2
            
            # Clone to a temporary directory inside the app source
            rm -rf .chart-cache
            # Support commit hashes by cloning and checking out explicitly
            git clone $REPO .chart-cache
            cd .chart-cache
            git checkout $REF
            echo "Init Complete." >&2
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Starting Generate..." >&2
            echo "--- Environment Variables ---" >&2
            env >&2
            echo "-----------------------------" >&2
            
            CHART_PATH=$(grep 'path:' git-chart.yaml | awk '{print $2}')
            echo "Chart Path: $CHART_PATH" >&2
            
            # Argo CD passes "namespace_name" as ARGOCD_APP_NAME. We need to extract the name.
            RELEASE_NAME=$(echo $ARGOCD_APP_NAME | awk -F_ '{print $NF}')
            echo "Release Name: $RELEASE_NAME" >&2
            
            HELM_ARGS=""
            if [ -n "$ARGOCD_ENV_HELM_VALUES" ]; then
              echo "Found HELM_VALUES env var" >&2
              echo "$ARGOCD_ENV_HELM_VALUES" > extra-values.yaml
              HELM_ARGS="-f extra-values.yaml"
            fi

            VALUES_FILE=${ARGOCD_ENV_VALUES_FILE:-values.yaml}
            if [ -f "$VALUES_FILE" ]; then
               echo "Using values file: $VALUES_FILE" >&2
               HELM_ARGS="-f $VALUES_FILE $HELM_ARGS"
            else
               echo "Values file $VALUES_FILE not found, skipping." >&2
            fi
            
            echo "Running Helm Template..." >&2
            helm template .chart-cache/$CHART_PATH --name-template $RELEASE_NAME --namespace $ARGOCD_APP_NAMESPACE --include-crds $HELM_ARGS > all.yaml
            
            echo "--- Content of all.yaml (Helm output) ---" >&2
            cat all.yaml >&2
            echo "------------------------------------------" >&2

            # Dynamically construct kustomization.yaml
            echo "Constructing kustomization.yaml..." >&2
            echo "apiVersion: kustomize.config.k8s.io/v1beta1" > kustomization.yaml
            echo "kind: Kustomization" >> kustomization.yaml
            echo "resources:" >> kustomization.yaml
            echo "  - all.yaml" >> kustomization.yaml

            if [ -n "$ARGOCD_ENV_KUSTOMIZE_PATCHES" ]; then
               echo "Found KUSTOMIZE_PATCHES env var." >&2
               echo "patches:" >> kustomization.yaml
               echo "$ARGOCD_ENV_KUSTOMIZE_PATCHES" | sed 's/^/  /' >> kustomization.yaml
            elif [ -n "$ARGOCD_ENV_KUSTOMIZE_PATCH" ]; then
               echo "Found KUSTOMIZE_PATCH env var. Adding patch to kustomization.yaml..." >&2
               echo "patches:" >> kustomization.yaml
               echo "  - target:" >> kustomization.yaml
               echo "      kind: StatefulSet" >> kustomization.yaml
               echo "      name: garage" >> kustomization.yaml
               echo "    patch: |-" >> kustomization.yaml
               echo "$ARGOCD_ENV_KUSTOMIZE_PATCH" | sed 's/^/      /' >> kustomization.yaml # Indent the patch value
            fi
            
            echo "--- Content of kustomization.yaml ---" >&2
            cat kustomization.yaml >&2
            echo "------------------------------------------" >&2

            echo "Running Kustomize Build..." >&2
            kustomize build
