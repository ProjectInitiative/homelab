apiVersion: v1
kind: ConfigMap
metadata:
  name: pulumi-cmp-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: pulumi-python
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args: ["pulumi-init"]
      generate:
        command: ["/bin/sh", "-c"]
        args: ["pulumi-generate"]
      discover:
        fileName: "Pulumi.yaml"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomized-helm-cmp-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: kustomized-helm
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args: ["helm dependency build"]
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            # Argo CD passes "namespace_name" as ARGOCD_APP_NAME. We need to extract the name.
            RELEASE_NAME=$(echo $ARGOCD_APP_NAME | awk -F_ '{print $NF}')
            
            helm template . --name-template $RELEASE_NAME --namespace $ARGOCD_APP_NAMESPACE --include-crds > all.yaml && kustomize build
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kustomized-git-helm-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: kustomized-git-helm
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Starting Init..." >&2
            
            # Parse git-chart.yaml for repo, ref, and chart_path
            REPO=$(grep 'repo:' git-chart.yaml | awk '{print $2}')
            REF=$(grep 'ref:' git-chart.yaml | awk '{print $2}')
            CHART_PATH=$(grep 'path:' git-chart.yaml | awk '{print $2}')
            
            echo "Repo: $REPO, Ref: $REF, Path: $CHART_PATH" >&2
            
            # Clone to a temporary directory inside the app source
            rm -rf .chart-cache
            git clone --depth 1 --branch $REF $REPO .chart-cache
            echo "Init Complete." >&2
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Starting Generate..." >&2
            echo "--- Environment Variables ---" >&2
            env >&2
            echo "-----------------------------" >&2
            
            CHART_PATH=$(grep 'path:' git-chart.yaml | awk '{print $2}')
            echo "Chart Path: $CHART_PATH" >&2
            
            # Argo CD passes "namespace_name" as ARGOCD_APP_NAME. We need to extract the name.
            RELEASE_NAME=$(echo $ARGOCD_APP_NAME | awk -F_ '{print $NF}')
            echo "Release Name: $RELEASE_NAME" >&2
            
            # Handle Extra Helm Values
            HELM_ARGS=""
            if [ -n "$HELM_VALUES" ]; then
              echo "Found HELM_VALUES env var" >&2
              echo "$HELM_VALUES" > extra-values.yaml
              HELM_ARGS="-f extra-values.yaml"
            fi
            
            # Run helm template against the cloned chart
            echo "Running Helm Template..." >&2
            helm template .chart-cache/$CHART_PATH --name-template $RELEASE_NAME --namespace $ARGOCD_APP_NAMESPACE --include-crds --values values.yaml $HELM_ARGS > all.yaml
            
            echo "--- Content of all.yaml (Helm output) ---" >&2
            cat all.yaml >&2
            echo "------------------------------------------" >&2

            # Dynamically construct kustomization.yaml
            echo "Constructing temporary kustomization.yaml..." >&2
            echo "apiVersion: kustomize.config.k8s.io/v1beta1" > tmp-kustomization.yaml
            echo "kind: Kustomization" >> tmp-kustomization.yaml
            echo "resources:" >> tmp-kustomization.yaml
            echo "  - all.yaml" >> tmp-kustomization.yaml

            if [ -n "$KUSTOMIZE_PATCH" ]; then
               echo "Found KUSTOMIZE_PATCH env var. Adding patch to temporary kustomization.yaml..." >&2
               echo "patches:" >> tmp-kustomization.yaml
               echo "  - target:" >> tmp-kustomization.yaml
               echo "      kind: StatefulSet" >> tmp-kustomization.yaml
               echo "      name: garage" >> tmp-kustomization.yaml
               echo "    patch: |-" >> tmp-kustomization.yaml
               echo "$KUSTOMIZE_PATCH" | sed 's/^/      /' >> tmp-kustomization.yaml # Indent the patch value
            fi
            
            echo "--- Content of tmp-kustomization.yaml ---" >&2
            cat tmp-kustomization.yaml >&2
            echo "------------------------------------------" >&2

            echo "Running Kustomize Build..." >&2
            kustomize build -k tmp-kustomization.yaml
