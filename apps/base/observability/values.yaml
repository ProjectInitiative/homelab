loki:
  deploymentMode: SingleBinary
  fullnameOverride: loki
  loki:
    auth_enabled: false
    common:
      replication_factor: 1
      storage:
        s3:
          endpoint: http://garage.garage.svc.clusterset.local:3900
          bucketnames: loki-chunks
          region: us-east-1
          insecure: true
          s3forcepathstyle: true
          access_key_id: "${S3_ACCESS_KEY}"
          secret_access_key: "${S3_SECRET_KEY}"
    schema_config:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: index_
            period: 24h
    ingester:
      chunk_target_size: 1572864
      max_chunk_age: 2h
      chunk_idle_period: 1h

  # Disable minio if enabled by default
  minio:
    enabled: false

  # Service Account for IAM (if used) or just ensure it runs
  serviceAccount:
    create: true

  singleBinary:
    extraEnv:
      - name: S3_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: loki-bucket-secret
            key: access_key
      - name: S3_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: loki-bucket-secret
            key: secret_key

kube-prometheus-stack:
  crds:
    enabled: false
  grafana:
    enabled: true
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.monitoring.svc.cluster.local:3100
        access: proxy
        jsonData:
          maxLines: 1000

  prometheus:
    prometheusSpec:
      retention: 6h
      enableAdminAPI: true
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      thanos:
        objectStorageConfig:
          name: thanos-objstore-secret
          key: objstore.yml
