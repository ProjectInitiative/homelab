garage:
  # These values are referenced by the garageTomlString template below.
  replicationFactor: 3
  consistencyMode: "consistent"
  metadataAutoSnapshotInterval: "24 hours"
  dbEngine: "lmdb"
  blockSize: "2M"
  # underlying storage handles this
  compressionLevel: "'none'"
  rpcBindAddr: "[::]:3901"
  bootstrapPeers: []
  kubernetesSkipCrd: false
  s3:
    api:
      region: "us-east-1"
      rootDomain: ".s3.moonwake.io"
    web:
      rootDomain: ".garage-web.moonwake.io"
      index: "index.html"

  # -- String Template for the garage configuration.
  garageTomlString: |-
    metadata_dir = "/mnt/meta"
    data_dir = "/mnt/data"

    # Your custom settings
    metadata_fsync = false
    data_fsync = false
    
    db_engine = "{{ .Values.garage.dbEngine }}"

    block_size = "{{ .Values.garage.blockSize }}"

    replication_factor = {{ .Values.garage.replicationFactor }}
    consistency_mode = "{{ .Values.garage.consistencyMode }}"

    compression_level = {{ .Values.garage.compressionLevel }}

    {{- if .Values.garage.metadataAutoSnapshotInterval }}
    metadata_auto_snapshot_interval = {{ .Values.garage.metadataAutoSnapshotInterval | quote }}
    {{- end }}

    rpc_bind_addr = "{{ .Values.garage.rpcBindAddr }}"
    # rpc_secret will be populated by the init container from a k8s secret object
    rpc_secret = "__RPC_SECRET_REPLACE__"

    bootstrap_peers = {{ .Values.garage.bootstrapPeers }}

    [kubernetes_discovery]
    namespace = "{{ .Release.Namespace }}"
    service_name = "{{ include "garage.fullname" . }}"
    skip_crd = {{ .Values.garage.kubernetesSkipCrd }}

    [s3_api]
    s3_region = "{{ .Values.garage.s3.api.region }}"
    api_bind_addr = "[::]:3900"
    root_domain = "{{ .Values.garage.s3.api.rootDomain }}"

    [s3_web]
    bind_addr = "[::]:3902"
    root_domain = "{{ .Values.garage.s3.web.rootDomain }}"
    index = "{{ .Values.garage.s3.web.index }}"

    [admin]
    api_bind_addr = "[::]:3903"
    {{- if .Values.monitoring.tracing.sink }}
    trace_sink = "{{ .Values.monitoring.tracing.sink }}"
    {{- end }}

# Start 3 instances (StatefulSets) of garage
deployment:
  kind: StatefulSet
  podManagementPolicy: Parallel
  replicaCount: 3

# Override default storage class and size for in-memory testing
persistence:
  meta:
    # Use an in-memory volume. The 'storageClass' and 'size' are replaced.
    emptyDir:
      medium: Memory
  data:
    # Use an in-memory volume. The 'storageClass' and 'size' are replaced.
    emptyDir:
      medium: Memory
