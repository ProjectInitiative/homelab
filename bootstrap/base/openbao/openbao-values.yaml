# Values for a HA OpenBao cluster with Raft storage and TPM-based auto-unseal.

server:
  image:
    registry: "ghcr.io/projectinitiative"
    repository: "openbao-hsm"
    tag: "latest"

  # --- High Availability and Raft Configuration ---
  standalone:
    enabled: false
  ha:
    enabled: true
    replicas: 3
    raft:
      enabled: true
      config: |
        ui = true
        listener "tcp" {
          tls_disable     = true
          address         = "[::]:8200"
          cluster_address = "[::]:8201"
        }
        storage "raft" {
          path = "/openbao/data"
          retry_join { leader_api_addr = "http://openbao-0.openbao-internal:8200" }
          retry_join { leader_api_addr = "http://openbao-1.openbao-internal:8200" }
          retry_join { leader_api_addr = "http://openbao-2.openbao-internal:8200" }
        }
        seal "pkcs11" {
          lib = "/usr/lib/libsofthsm2.so"
          token_label = "openbao-token"
          key_label   = "openbao-unseal-key"
          rsa_oaep_hash = "sha1"
        }

  # --- Persistent Volumes Configuration ---
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: "local-path-sticky"

  # --- CORRECTED: Volume and Mount Definitions for TPM and PKCS11 Store ---
  # Define all volumes here as required by the chart's structure.
  volumes:
    - name: pkcs11-store
      persistentVolumeClaim:
        claimName: pkcs11-store
    - name: tpmrm0-device # <-- NEW: Define TPM device as a volume
      hostPath:
        path: /dev/tpmrm0
    - name: tpm-device # <-- NEW: Define TPM device as a volume
      hostPath:
        path: /dev/tpm0

  # Mount the shared volume into the main 'openbao' container
  volumeMounts:
    - name: pkcs11-store
      mountPath: /pkcs11-store
    - name: tpmrm0-device # <-- NEW: Mount TPM into the main container
      mountPath: /dev/tpmrm0
    - name: tpm-device # <-- NEW: Mount TPM into the main container
      mountPath: /dev/tpm0

  # --- CORRECTED: Init Container now under 'extraInitContainers' ---
  extraInitContainers:
    - name: pkcs11-init
      image: "ghcr.io/projectinitiative/tpm2_pkcs11-init:latest"
      imagePullPolicy: IfNotPresent
      command: ["/bin/entrypoint.sh"]
      env:
        - name: SO_PIN
          valueFrom:
            secretKeyRef:
              name: openbao-unseal-pin
              key: pin
        - name: USER_PIN
          valueFrom:
            secretKeyRef:
              name: openbao-unseal-pin
              key: pin
        - name: TOKEN_NAME
          value: "openbao-token"
        - name: KEY_LABEL
          value: "openbao-unseal-key"
        - name: FAPI_PROFILE_DIR
          value: "/pkcs11-store/fapi-profiles"
        - name: TPM2_PKCS11_STORE
          value: "/pkcs11-store"
        - name: TSS2_TCTI
          value: "device:/dev/tpmrm0"
      volumeMounts:
        # Mount the shared volume so the init container can create the files.
        - name: pkcs11-store
          mountPath: /pkcs11-store
        # Mount the TPM devices from the volumes defined above.
        - name: tpmrm0-device
          mountPath: /dev/tpmrm0
        - name: tpm-device
          mountPath: /dev/tpm0
      # The init container needs access to the host's TPM device.
      securityContext:
        privileged: true

  # --- TPM Device Environment Variables ---
  extraEnvironmentVars:
    TSS2_TCTI: "device:/dev/tpmrm0"
    TPM2_PKCS11_STORE: "/pkcs11-store"
