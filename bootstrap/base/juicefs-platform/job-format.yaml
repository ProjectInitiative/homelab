apiVersion: batch/v1
kind: Job
metadata:
  name: juicefs-format
  namespace: juicefs-platform
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: juicefs-format
          image: juicedata/juicefs-csi-driver:v0.20.1
          command:
            - /bin/sh
            - -c
            - |
              # Check if already formatted
              if juicefs status "$metaurl" >/dev/null 2>&1; then
                echo "JuiceFS filesystem '$name' is already formatted."
                exit 0
              fi

              echo "Formatting JuiceFS filesystem '$name'..."
              
              # Construct format command
              CMD="juicefs format --storage $storage --bucket $bucket --access-key $access_key --secret-key $secret_key --yes"
              
              if [ -f "/etc/juicefs/private.pem" ]; then
                echo "Using RSA Key for encryption."
                CMD="$CMD --encrypt-rsa-key /etc/juicefs/private.pem"
              elif [ -n "$passphrase" ]; then
                 # Fallback to symmetric if no key file but passphrase exists
                 echo "Using passphrase for encryption (symmetric)."
                 echo "$passphrase" | $CMD --encrypt-key "$metaurl" "$name"
                 exit $?
              fi
              
              # Execute format
              $CMD "$metaurl" "$name"
          volumeMounts:
            - name: rsa-key
              mountPath: "/etc/juicefs"
              readOnly: true
          env:
            - name: JFS_RSA_PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: passphrase
                  optional: true
            - name: passphrase
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: passphrase
                  optional: true
            - name: storage
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: storage
            - name: bucket
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: bucket
            - name: access_key
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: access-key
            - name: secret_key
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: secret-key
            - name: metaurl
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: metaurl
            - name: name
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: name
      volumes:
        - name: rsa-key
          secret:
            secretName: juicefs-key
            optional: true
            items:
              - key: cert
                path: private.pem
