apiVersion: batch/v1
kind: Job
metadata:
  name: juicefs-format
  namespace: juicefs-platform
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: juicefs-format
          image: juicedata/juicefs-csi-driver:v0.20.1
          command:
            - /bin/sh
            - -c
            - |
              # Check if already formatted
              if juicefs status "$metaurl" >/dev/null 2>&1; then
                echo "JuiceFS filesystem '$name' is already formatted."
                exit 0
              fi

              echo "Formatting JuiceFS filesystem '$name'..."
              
              # Construct format command
              CMD="juicefs format --storage $storage --bucket $bucket --access-key $access_key --secret-key $secret_key --yes"
              
              if [ -n "$passphrase" ]; then
                echo "Using passphrase for encryption."
                CMD="$CMD --encrypt-key"
                # The passphrase is read from JFS_RSA_PASSPHRASE env var by default if using RSA, 
                # but for symmetric 'encrypt-key' it reads from stdin or JFS_RSA_PASSPHRASE? 
                # Actually for symmetric, it asks for input.
                # However, JuiceFS CSI driver sets JFS_RSA_PASSPHRASE or JFS_NO_UPDATE_DIR_STAT envs.
                # For automation, we can pass it via env JFS_RSA_PASSPHRASE (works for symmetric too in newer versions)
                # OR pipe it.
              fi
              
              # Execute format
              # We use the env vars directly where possible to avoid logging secrets
              # 'metaurl' and 'name' are positional arguments
              
              $CMD "$metaurl" "$name"
          env:
            - name: JFS_RSA_PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: passphrase
                  optional: true
            - name: storage
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: storage
            - name: bucket
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: bucket
            - name: access_key
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: access-key
            - name: secret_key
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: secret-key
            - name: metaurl
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: metaurl
            - name: name
              valueFrom:
                secretKeyRef:
                  name: juicefs-creds
                  key: name
