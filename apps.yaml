defaults:
  repoURL: https://github.com/projectinitiative/homelab.git
  targetRevision: HEAD
  # syncPolicy defaults are now handled in the Pulumi code

catalog:
  # Bootstrap / Infrastructure
  kube-vip-app:
    path: bootstrap/mc/kube-vip/config
    annotations:
      argocd.argoproj.io/sync-wave: "0"
    syncPolicy:
      syncOptions:
        - CreateNamespace=false
        - ServerSideApply=true
  
  local-path-provisioner:
    path: bootstrap/base/local-path-provisioner/config
    annotations:
      argocd.argoproj.io/sync-wave: "0"
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
        - ApplyOutOfSyncOnly=true
        - RespectIgnoreDifferences=true
  
  policies:
    path: bootstrap/base/policies
    annotations:
      argocd.argoproj.io/sync-wave: "0"
    syncPolicy:
      syncOptions:
        - CreateNamespace=false # Policies usually don't need their own namespace
        - ServerSideApply=true
        - ApplyOutOfSyncOnly=true
        - RespectIgnoreDifferences=true
  
  sc-local-path:
    path: bootstrap/mc/lpp 
    directory:
      include: '*.yaml'
  
  tpm-device-plugin:
    path: bootstrap/base/tpm-device-plugin/plugin
    annotations:
      argocd.argoproj.io/sync-wave: "10"
    syncPolicy:
      syncOptions: []
  
  cert-manager:
    annotations:
      argocd.argoproj.io/sync-wave: "50"
    sources:
      - repoURL: https://charts.jetstack.io
        chart: cert-manager
        targetRevision: v1.18.1
        helm:
          valueFiles:
            - $values/bootstrap/base/cert-manager/cert-manager-values.yaml
      - repoURL: https://github.com/projectinitiative/homelab.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
        - ApplyOutOfSyncOnly=true
        - RespectIgnoreDifferences=true
  
  openbao:
    annotations:
      argocd.argoproj.io/sync-wave: "90"
    sources:
      - repoURL: https://openbao.github.io/openbao-helm
        chart: openbao
        targetRevision: 0.16.1
        helm:
          valueFiles:
            - $values/bootstrap/base/openbao/openbao-values.yaml
      - repoURL: https://github.com/projectinitiative/homelab.git
        targetRevision: HEAD
        ref: values
      - repoURL: https://github.com/projectinitiative/homelab.git
        targetRevision: HEAD
        path: bootstrap/base/openbao/config
    ignoreDifferences:
      - group: admissionregistration.k8s.io
        jsonPointers:
        - /webhooks/0/clientConfig/caBundle
        kind: MutatingWebhookConfiguration
        name: openbao-agent-injector-cfg
  
  openbao-auth-config:
    path: bootstrap/base/openbao-auth-config/config
    syncPolicy:
      syncOptions: []
  
  openbao-secrets-operator:
    repoURL: https://github.com/openbao/openbao-secrets-operator.git
    path: chart
    targetRevision: main
    helm:
      values: |
        controller:
          manager:
            args: ["-v=4"]
        defaultVaultConnection:
          enabled: false
  
  cnpg-operator:
    annotations:
      argocd.argoproj.io/sync-wave: "30"
    sources:
      - repoURL: https://cloudnative-pg.github.io/charts
        chart: cloudnative-pg
        targetRevision: 0.21.1
        helm:
          values: |
            crds.create: true
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
  
  tidb-operator:
    annotations:
      argocd.argoproj.io/sync-wave: "30"
    sources:
      - repoURL: https://charts.pingcap.org/
        chart: tidb-operator
        targetRevision: v1.6.3
      - repoURL: https://github.com/pingcap/tidb-operator.git
        targetRevision: v1.6.3
        path: manifests
        directory:
            include: 'crd.yaml'
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true

  tikv-cluster:
    path: bootstrap/base/tikv-cluster
    annotations:
      argocd.argoproj.io/sync-wave: "40"
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true

  juicefs-csi-driver:
    annotations:
      argocd.argoproj.io/sync-wave: "30"
    sources:
      - repoURL: https://juicedata.github.io/charts/
        chart: juicefs-csi-driver
        targetRevision: 0.20.1
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true

  juicefs-platform:
    path: bootstrap/base/juicefs-platform
    annotations:
      argocd.argoproj.io/sync-wave: "50"
    vaultSecrets:
      createAuth: true
      namespace: production
      role: openbao-secrets-operator
      audiences:
        - vault
      secrets:
        - name: juicefs-creds
          mount: k8s
          path: "juicefs/config"
          destination: "juicefs-creds"
        - name: juicefs-key
          mount: k8s
          path: "juicefs/pem"
          destination: "juicefs-key"
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true

  postgres-cluster:
    path: bootstrap/base/cnpg/database
    annotations:
      argocd.argoproj.io/sync-wave: "40"
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
    
  garage:
    path: bootstrap/base/garage
    plugin:
      name: kustomized-git-helm-v1.0
    annotations:
      argocd.argoproj.io/sync-wave: "100"
    vaultSecrets:
      createAuth: true
      role: openbao-secrets-operator
      namespace: production
      audiences:
        - vault
      secrets:
        - name: garage-rpc-secret
          mount: k8s
          path: "garage/rpc"
          destination: "garage-rpc-secret"
    ignoreDifferences:
      - group: ""
        jsonPointers:
        - /data/rpcSecret
        kind: Secret
        name: garage-rpc-secret
      - group: apps
        kind: StatefulSet
        jqPathExpressions:
        - .spec.volumeClaimTemplates[].status
        - .spec.volumeClaimTemplates[].metadata.creationTimestamp
        - .spec.volumeClaimTemplates[].apiVersion
        - .spec.volumeClaimTemplates[].kind
    syncPolicy:
      automated:
        prune: false
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
  
  tailscale-operator:
    sources:
      - repoURL: https://pkgs.tailscale.com/helmcharts
        chart: tailscale-operator
        targetRevision: 1.90.9
        helm:
          values: |
            apiServerProxyConfig:
              mode: "true"
              allowImpersonation: "true"
    vaultSecrets:
      createAuth: true
      role: openbao-secrets-operator
      namespace: production
      audiences:
        - vault
      secrets:
        - name: tailscale-auth
          mount: k8s
          path: "tailscale-operator"
          destination: "operator-oauth"
  
  garage-mem:
    path: bootstrap/mc/garage-mem

  prometheus-operator-crds:
    annotations:
      argocd.argoproj.io/sync-wave: "10"
    sources:
      - repoURL: https://prometheus-community.github.io/helm-charts
        chart: prometheus-operator-crds
        targetRevision: 17.0.2
    syncPolicy:
      syncOptions:
        - ServerSideApply=true

  grafana-alloy:
    sources:
      - repoURL: https://grafana.github.io/helm-charts
        chart: alloy
        targetRevision: 0.9.1
        helm:
          values: |
            alloy:
              clustering:
                enabled: true
                name: "homelab-alloy-cluster"
                portName: "http"
              configMap:
                content: |
                  logging {
                    level = "info"
                    format = "logfmt"
                  }

                  discovery.kubernetes "pods" {
                    role = "pod"
                  }

                  loki.source.kubernetes "pod_logs" {
                    targets    = discovery.kubernetes.pods.targets
                    forward_to = [loki.write.default.receiver]
                  }

                  loki.write "default" {
                    endpoint {
                      url = "http://100.119.112.42:3100/loki/api/v1/push"
                    }
                  }

                  // Prometheus Operator Support
                  prometheus.operator.servicemonitors "primary_sm" {
                    clustering {
                        enabled = true
                    }
                    forward_to = [prometheus.remote_write.default.receiver]
                  }

                  prometheus.operator.podmonitors "primary_pm" {
                    clustering {
                        enabled = true
                    }
                    forward_to = [prometheus.remote_write.default.receiver]
                  }

                  prometheus.remote_write "default" {
                    endpoint {
                      url = "http://100.119.112.42:9090/api/v1/write"
                    }
                  }

  # Apps
  tailscale-proxy-groups:
    path: apps/base/tailscale-proxy-groups/config
    syncPolicy:
      syncOptions: []
  
  temp-egress:
    path: apps/base/temp-egress/config
    syncPolicy:
      syncOptions: []
  
  dnsutils:
    path: apps/base/dnsutils/config
  
  docker-registry:
    path: apps/base/docker-registry/config
  
  privateer:
    path: apps/base/privateer/config