# clusters/mc.yaml
name: mc
server: https://172.16.1.50:6443
project: mc-bootstrap
argoNamespace: argocd-mc
vaultMount: kubernetes_cluster_mc
apps:
  - name: kube-vip-app
    namespace: kube-system
  - name: local-path-provisioner
    namespace: local-path-storage
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: local-path-config
      data:
        config.json: |
          {
            "nodePathMap": [
              {
                "node": "DEFAULT_PATH_FOR_NON_LISTED_NODES",
                "paths": [
                  "/mnt/local-provisioner",
                  "/mnt/local-provisioner/nvme-cache",
                  "/mnt/local-provisioner/host",
                  "/mnt/local-provisioner/hdd"
                ]
              }
            ]
          }
    patchTarget:
      kind: ConfigMap
      name: local-path-config
  - name: tpm-device-plugin
    namespace: kube-system
  - name: tailscale-operator
    namespace: tailscale
  - name: openbao
    namespace: openbao
  - name: openbao-auth-config
    namespace: kube-system
    patch: |-
      apiVersion: secrets.hashicorp.com/v1beta1
      kind: VaultAuth
      metadata:
        name: operator-auth
      spec:
        mount: kubernetes_cluster_mc
        kubernetes:
          role: openbao-secrets-operator
    patchTarget:
      kind: VaultAuth
      name: operator-auth
  - name: openbao-secrets-operator
    namespace: openbao-secrets-operator
    helm_values: |
      vault:
        address: http://openbao.openbao:8200
        auth:
          method: kubernetes
          path: kubernetes_cluster_mc
          role: openbao-secrets-operator
  - name: cnpg-operator
    namespace: cnpg-system
  - name: tidb-operator
    namespace: tikv-operator
  - name: tikv-cluster
    namespace: tikv-cluster
  - name: juicefs-csi-driver
    namespace: kube-system
  - name: juicefs-platform
    namespace: juicefs-platform
  - name: postgres-cluster
    namespace: postgres-db
  - name: garage
    namespace: garage
    plugin:
      name: kustomized-git-helm-v1.0
      env:
        - name: VALUES_FILE
          value: garage-values.yaml
        - name: HELM_VALUES
          value: |
            garage:
              metadataAutoSnapshotInterval: "2 hours"
              metadataSnapshotDir: /snapshots
            persistence:
              meta:
                storageClass: "host-local-path-nvme-sticky"
            extraVolumeMounts:
              - name: snapshots
                mountPath: /snapshots
        # - name: KUSTOMIZE_PATCH
        #   value: |
        #     - op: add
        #       path: /spec/volumeClaimTemplates/-
        #       value:
        #         metadata:
        #           name: snapshots
        #         spec:
        #           accessModes: [ "ReadWriteOnce" ]
        #           storageClassName: "local-path-hdd-sticky"
        #           resources:
        #             requests:
        #               storage: "20Gi"
  - name: sc-local-path-nvme
    namespace: default
  - name: tailscale-proxy-groups
    namespace: tailscale
    source_path: overlays/main-cluster/tailscale-proxy-group
  - name: temp-egress
    namespace: default
  - name: dnsutils
    namespace: dnsutils
  - name: docker-registry
    namespace: registry
  - name: prometheus-operator-crds
    namespace: monitoring
  - name: grafana-alloy
    namespace: monitoring
